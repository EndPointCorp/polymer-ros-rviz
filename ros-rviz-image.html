<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="imports.html">

<dom-module id="ros-rviz-image">
  <template>
    <paper-input label="Image topic" value="{{topic}}"></paper-input>
    <paper-dropdown-menu id="transport_hints_list" label="Transport hints" on-iron-select="transportHintSelected">
      <paper-listbox slot="dropdown-content" class="dropdown-content" selected="0">
        <paper-item>Compressed</paper-item>
        <paper-item>CompressedDepth</paper-item>
      </paper-listbox>
    </paper-dropdown-menu>
    <iron-image id="xy_image" src="[[image_source]]" alt="iron-image" ></iron-image>
  </template>
  <script>
    const _transportHints = {
      Compressed: {type: 'sensor_msgs/CompressedImage', topicSuffix: '/compressed'},
      CompressedDepth: {type: 'sensor_msgs/CompressedImage', topicSuffix: '/compressedDepth'},
    };

    Polymer({
      is: 'ros-rviz-image',

      properties: {
        name: {
          type: String,
          value: 'Image',
        },
        topic: {
          type: String,
          value: '/camera/image/compressed',
          notify: true,
        },
        image_source: {
          type: String,
          value: '',
        },
        transport_hints: {
          type: String,
          value: 'Compressed',
          notify: true,
        },
        globalOptions: Object,
        isShown: Boolean,
        ros: Object,
        tfClient: Object,
        viewer: Object,
      },

      observers: [
        '_optionsChanged(viewer, topic, ros)',
      ],

      transportHintSelected: function(e) {
        this.transport_hints = this.$.transport_hints_list.selectedItemLabel;
        this._optionsChanged();
      },

      destroy: function() {
        // Nothing to destroy.
      },

      hide: function() {
        if (this._imageTopic) {
          this._imageTopic.unsubscribe();
          this._imageTopic = null;
        }
      },

      show: function() {
        if (this.viewer && this.isShown) {
          if (!this._imageTopic) {
            this._updateDisplay();
          }
        }
      },

      _optionsChanged: function(viewer, topic, ros) {
        this.hide();
        this._updateDisplay();
        this.show();
      },

      _updateDisplay: function(callback) {
        console.log('Image updating display')
        var that = this;

        if (!(this.ros && this.viewer && this.topic &&
             (this.transport_hints))) {
          return;
        }
        if (this._imageTopic) {
          this._imageTopic.unsubscribe();
        }

        this._imageTopic = new ROSLIB.Topic({
            ros : this.ros,
            name : this.topic + _transportHints[this.transport_hints].topicSuffix,
            messageType : _transportHints[this.transport_hints].type
        });

        this._imageTopic.subscribe(function(message) {
          console.log('Received message on image viewer');
          var imagedata = "data:image/jpg;base64," + message.data;
          that._setImageSource(imagedata);
        });
      },

      _setImageSource: function(data) {
        this.image_source = data
      },
    });
  </script>
</dom-module>
